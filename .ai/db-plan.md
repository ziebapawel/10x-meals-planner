# Database Schema for Meals Planner

## 1. Tables

### `meal_plans`

Stores the configuration and metadata for each meal plan generated by a user.

| Column Name  | Data Type     | Constraints                                         | Description                             |
| ------------ | ------------- | --------------------------------------------------- | --------------------------------------- |
| `id`         | `UUID`        | `PRIMARY KEY`, `DEFAULT gen_random_uuid()`          | Unique identifier for the meal plan.    |
| `user_id`    | `UUID`        | `NOT NULL`, `FOREIGN KEY REFERENCES auth.users(id)` | ID of the user who owns the plan.       |
| `plan_input` | `JSONB`       | `NOT NULL`                                          | User's input from the generation form.  |
| `created_at` | `TIMESTAMPTZ` | `NOT NULL`, `DEFAULT now()`                         | Timestamp of when the plan was created. |
| `updated_at` | `TIMESTAMPTZ` | `NOT NULL`, `DEFAULT now()`                         | Timestamp of the last update.           |

### `meals`

Stores the details for each individual meal within a meal plan.

| Column Name   | Data Type     | Constraints                                         | Description                                 |
| ------------- | ------------- | --------------------------------------------------- | ------------------------------------------- |
| `id`          | `UUID`        | `PRIMARY KEY`, `DEFAULT gen_random_uuid()`          | Unique identifier for the meal.             |
| `plan_id`     | `UUID`        | `NOT NULL`, `FOREIGN KEY REFERENCES meal_plans(id)` | ID of the meal plan this meal belongs to.   |
| `recipe_data` | `JSONB`       | `NOT NULL`                                          | Detailed recipe, ingredients, and portions. |
| `day`         | `INTEGER`     | `NOT NULL`                                          | The day number within the plan (e.g., 1-7). |
| `type`        | `TEXT`        | `NOT NULL`                                          | Type of meal (e.g., 'breakfast', 'dinner'). |
| `created_at`  | `TIMESTAMPTZ` | `NOT NULL`, `DEFAULT now()`                         | Timestamp of when the meal was created.     |

### `shopping_lists`

Stores the aggregated shopping list for a specific meal plan.

| Column Name    | Data Type     | Constraints                                                   | Description                                  |
| -------------- | ------------- | ------------------------------------------------------------- | -------------------------------------------- |
| `id`           | `UUID`        | `PRIMARY KEY`, `DEFAULT gen_random_uuid()`                    | Unique identifier for the shopping list.     |
| `plan_id`      | `UUID`        | `NOT NULL`, `UNIQUE`, `FOREIGN KEY REFERENCES meal_plans(id)` | ID of the associated meal plan.              |
| `list_content` | `JSONB`       | `NOT NULL`                                                    | Categorized list of ingredients and amounts. |
| `created_at`   | `TIMESTAMPTZ` | `NOT NULL`, `DEFAULT now()`                                   | Timestamp of when the list was generated.    |

## 2. Relationships

- **`auth.users` to `meal_plans`**: One-to-Many
  - A single user can have multiple meal plans.
  - Implemented via `meal_plans.user_id` foreign key.
- **`meal_plans` to `meals`**: One-to-Many
  - A single meal plan consists of multiple meals.
  - Implemented via `meals.plan_id` foreign key.
- **`meal_plans` to `shopping_lists`**: One-to-One
  - Each meal plan has exactly one corresponding shopping list.
  - Implemented via a `UNIQUE` foreign key `shopping_lists.plan_id`.

## 3. Indexes

To optimize query performance, especially for fetching data specific to a user or a plan.

- `CREATE INDEX ON meal_plans (user_id);`
- `CREATE INDEX ON meals (plan_id);`
- `CREATE INDEX ON shopping_lists (plan_id);`

## 4. Row-Level Security (RLS) Policies

RLS will be enabled for all tables to ensure users can only access their own data.

### `meal_plans` table

- **Enable RLS**: `ALTER TABLE meal_plans ENABLE ROW LEVEL SECURITY;`
- **SELECT Policy**: `CREATE POLICY "Allow users to see their own meal plans" ON meal_plans FOR SELECT USING (auth.uid() = user_id);`
- **INSERT Policy**: `CREATE POLICY "Allow users to create meal plans" ON meal_plans FOR INSERT WITH CHECK (auth.uid() = user_id);`
- **UPDATE Policy**: `CREATE POLICY "Allow users to update their own meal plans" ON meal_plans FOR UPDATE USING (auth.uid() = user_id);`
- **DELETE Policy**: `CREATE POLICY "Allow users to delete their own meal plans" ON meal_plans FOR DELETE USING (auth.uid() = user_id);`

### `meals` table

- **Enable RLS**: `ALTER TABLE meals ENABLE ROW LEVEL SECURITY;`
- **SELECT Policy**: `CREATE POLICY "Allow users to see meals from their own plans" ON meals FOR SELECT USING (EXISTS (SELECT 1 FROM meal_plans WHERE meal_plans.id = meals.plan_id AND meal_plans.user_id = auth.uid()));`
- **INSERT Policy**: `CREATE POLICY "Allow users to create meals for their own plans" ON meals FOR INSERT WITH CHECK (EXISTS (SELECT 1 FROM meal_plans WHERE meal_plans.id = meals.plan_id AND meal_plans.user_id = auth.uid()));`
- **UPDATE Policy**: `CREATE POLICY "Allow users to update meals in their own plans" ON meals FOR UPDATE USING (EXISTS (SELECT 1 FROM meal_plans WHERE meal_plans.id = meals.plan_id AND meal_plans.user_id = auth.uid()));`
- **DELETE Policy**: `CREATE POLICY "Allow users to delete meals from their own plans" ON meals FOR DELETE USING (EXISTS (SELECT 1 FROM meal_plans WHERE meal_plans.id = meals.plan_id AND meal_plans.user_id = auth.uid()));`

### `shopping_lists` table

- **Enable RLS**: `ALTER TABLE shopping_lists ENABLE ROW LEVEL SECURITY;`
- **SELECT Policy**: `CREATE POLICY "Allow users to see their own shopping lists" ON shopping_lists FOR SELECT USING (EXISTS (SELECT 1 FROM meal_plans WHERE meal_plans.id = shopping_lists.plan_id AND meal_plans.user_id = auth.uid()));`
- **INSERT Policy**: `CREATE POLICY "Allow users to create shopping lists for their own plans" ON shopping_lists FOR INSERT WITH CHECK (EXISTS (SELECT 1 FROM meal_plans WHERE meal_plans.id = shopping_lists.plan_id AND meal_plans.user_id = auth.uid()));`
- **UPDATE Policy**: `CREATE POLICY "Allow users to update their own shopping lists" ON shopping_lists FOR UPDATE USING (EXISTS (SELECT 1 FROM meal_plans WHERE meal_plans.id = shopping_lists.plan_id AND meal_plans.user_id = auth.uid()));`
- **DELETE Policy**: `CREATE POLICY "Allow users to delete their own shopping lists" ON shopping_lists FOR DELETE USING (EXISTS (SELECT 1 FROM meal_plans WHERE meal_plans.id = shopping_lists.plan_id AND meal_plans.user_id = auth.uid()));`

## 5. Additional Notes

- **`auth.users` Table**: This schema assumes the existence of the `auth.users` table provided by Supabase Authentication. The `user_id` columns in this schema directly reference the `id` from that table.
- **Use of `JSONB`**: The `JSONB` data type is used to store semi-structured data like form inputs, recipes, and shopping lists. This provides flexibility for the MVP and is efficient for storage and retrieval, though querying specific nested fields can be less performant than using normalized tables. For the scope of this project, it is the optimal choice.
- **Triggers for `updated_at`**: For production use, it would be beneficial to create a database trigger function that automatically updates the `updated_at` column on any row modification to ensure data accuracy.
